<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ranking - Missão RAC 03</title>
  <style>
    body{ font-family:Arial, sans-serif; max-width:1000px; margin:40px auto; padding:0 16px; color:#222; }
    h1{ margin:0 0 12px 0; }
    .controls{ display:flex; gap:10px; margin:12px 0 20px; flex-wrap:wrap; }
    input[type="text"]{ padding:8px 10px; font-size:14px; min-width:240px; }
    button{ background:#007bff; color:#fff; border:none; padding:10px 16px; font-size:14px; border-radius:6px; cursor:pointer; }
    table{ border-collapse:collapse; width:100%; }
    th, td{ border:1px solid #e5e7eb; padding:8px; text-align:left; font-size:14px; }
    th{ background:#f4f7fa; }
    .muted{ color:#6b7280; font-size:12px; }
    .right{ text-align:right; }
  </style>
</head>
<body>
  <h1> - Missão RAC 03</h1>
  <div class="muted">Ordenado por <b>maior Média Geral</b> (melhor desempenho aparece primeiro).</div>

  <div class="controls">
    <input id="search" type="text" placeholder="Filtrar por nome..." />
    <button id="refreshBtn">Atualizar</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>Nome</th>
        <th class="right">Média Geral</th>
        <th>Perfil de Risco</th>
        <th>Perfil de Atenção</th>
        <th class="right">Média Técnica</th>
        <th class="right">Média Comport.</th>
        <th class="right">Índice Comb.</th>
        <th>Versão</th>
        <th>Origem</th>
        <th>Data/Hora</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  (function(){
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxuUxkq859eZTOUN7Etoyk29JyHgQMVSVsuEhLECK3YpYYgaqsi09coqvz9_x1SK0UJ9A/exec';
    const tbody = document.querySelector('#tbl tbody');
    const search = document.getElementById('search');
    const refreshBtn = document.getElementById('refreshBtn');

    let rows = [];

    // --- Parse robusto: aceita 2,63 | 2.63 | 1.234,56 | 1,234.56
    function parseNum(v){
      if (v === null || v === undefined) return null;
      if (typeof v === 'number' && Number.isFinite(v)) return v;
      let s = String(v).trim();
      if (s === '') return null;

      // remove espaços
      s = s.replace(/\s/g, '');

      // se tem vírgula e ponto, decide quem é separador decimal pelo último símbolo
      if (s.includes(',') && s.includes('.')) {
        if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
          // vírgula é decimal => remove pontos (milhar) e troca vírgula por ponto
          s = s.replace(/\./g, '').replace(',', '.');
        } else {
          // ponto é decimal => remove vírgulas (milhar)
          s = s.replace(/,/g, '');
        }
      } else if (s.includes(',')) {
        // só vírgula => vírgula decimal
        s = s.replace(',', '.');
      } // se só ponto, mantém

      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function fmt(n){ return (n===null || n===undefined || n==='') ? '' : Number(n).toFixed(2); }
    function fmtDate(v){
      try{ const d = new Date(v); if(!isNaN(d)) return d.toLocaleString(); }catch(_){}
      return String(v||'');
    }

    // comparadores auxiliares
    function descBy(objA, objB, key){
      const a = parseNum(objA[key]);
      const b = parseNum(objB[key]);
      if (a === null && b === null) return 0;
      if (a === null) return 1;   // nulos ao fim
      if (b === null) return -1;
      return b - a; // descendente
    }

    function dateDesc(a, b, key){
      const da = new Date(a[key]);
      const db = new Date(b[key]);
      const va = isNaN(da) ? null : da.getTime();
      const vb = isNaN(db) ? null : db.getTime();
      if (va === null && vb === null) return 0;
      if (va === null) return 1;
      if (vb === null) return -1;
      return vb - va; // mais recente primeiro
    }

    function sortRanking(arr){
      // retorna uma cópia ordenada (não muta rows original)
      return arr.slice().sort((a, b) => {
        let d = descBy(a, b, 'MediaGeral');
        if (d) return d;
        d = descBy(a, b, 'MediaTecnica');
        if (d) return d;
        d = descBy(a, b, 'MediaComportamental');
        if (d) return d;
        d = descBy(a, b, 'IndiceCombinado');
        if (d) return d;
        d = dateDesc(a, b, 'DataHora');
        if (d) return d;
        return String(a.Nome||'').localeCompare(String(b.Nome||''), 'pt-BR', { sensitivity: 'base' });
      });
    }

    function render(){
      const q = (search.value||'').toLowerCase();
      const filtered = rows.filter(r => !q || String(r.Nome||'').toLowerCase().includes(q));

      // ✅ garantir ordenação sempre na renderização
      const data = sortRanking(filtered);

      // DEBUG: ver top 10 no console
      try {
        console.clear();
        console.table(data.slice(0,10).map(x => ({
          Nome: x.Nome,
          MediaGeral: parseNum(x.MediaGeral),
          MediaTecnica: parseNum(x.MediaTecnica),
          MediaComportamental: parseNum(x.MediaComportamental),
          IndiceCombinado: parseNum(x.IndiceCombinado),
          DataHora: x.DataHora
        })));
      } catch(_) {}

      tbody.innerHTML = '';
      data.forEach((r,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.Nome||''}</td>
          <td class="right">${fmt(parseNum(r.MediaGeral))}</td>
          <td>${r.PerfilRisco||''}</td>
          <td>${r.PerfilAtencao||''}</td>
          <td class="right">${fmt(parseNum(r.MediaTecnica))}</td>
          <td class="right">${fmt(parseNum(r.MediaComportamental))}</td>
          <td class="right">${fmt(parseNum(r.IndiceCombinado))}</td>
          <td>${r.VersaoForm||''}</td>
          <td>${r.Origem||''}</td>
          <td>${fmtDate(r.DataHora)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function load(){
      fetch(ENDPOINT_URL + '?action=list')
        .then(r => r.json())
        .then(j => {
          if(j && j.status === 'OK' && Array.isArray(j.rows)){
            // guarda como veio; a ordenação acontece no render()
            rows = j.rows;
          } else {
            rows = [];
          }
          render();
        })
        .catch(err => {
          console.error('Falha ao carregar ranking:', err);
          rows = [];
          render();
        });
    }

    search.addEventListener('input', render);
    refreshBtn.addEventListener('click', load);
    load();
  })();
  </script>
</body>
</html>

